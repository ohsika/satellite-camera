<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Auto StreetView Camera</title>

<style>
body { margin:0; background:#111; color:white; text-align:center; font-family:sans-serif; }
button {
  margin-top:20px;
  padding:15px 25px;
  font-size:20px;
  background:#333;
  border:none;
  border-radius:10px;
  color:white;
}
canvas { margin-top:20px; border-radius:10px; }
h3 { margin-top:10px; color:#ccc; font-size:16px; }
</style>
</head>

<body>

<h2>ğŸ“¡ Auto StreetView Camera</h2>
<h3 id="status">ğŸ“ GPS ìœ„ì¹˜ ì–»ëŠ” ì¤‘...</h3>

<button onclick="shoot()">ğŸ“· ì…”í„°</button>

<canvas id="canvas" width="400" height="400"></canvas>

<h3 id="angle">roll=0 pitch=0 yaw=0</h3>

<script>
const API_KEY = "AIzaSyCJwQpLT9pLj_zZIfFVN007MDOPnTqs5Gs";  // ë„ˆ API í‚¤

let lat = null, lon = null;
let roll=0, pitch=0, yaw=0;
let img = new Image();
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");

function updateStatus(msg){ 
    document.getElementById("status").innerText = msg; 
}

// -------------------------------
// 1) GPS ìë™ ì½ê¸°
// -------------------------------
function initGPS(){
    if (!navigator.geolocation){
        updateStatus("âŒ GPS ì§€ì› ì•ˆë¨");
        return;
    }
    navigator.geolocation.getCurrentPosition(
        (pos)=>{
            lat = pos.coords.latitude;
            lon = pos.coords.longitude;
            updateStatus(`ìœ„ì¹˜ OK: ${lat.toFixed(5)}, ${lon.toFixed(5)}`);
        },
        (err)=>{
            updateStatus("âŒ GPS ê¶Œí•œ ê±°ë¶€ë¨");
        },
        { enableHighAccuracy:true }
    );
}

// -------------------------------
// 2) ì„¼ì„œ ê¸°ìš¸ê¸° ì½ê¸°
// -------------------------------
window.addEventListener("deviceorientation", (e)=>{
    roll = e.gamma || 0;   // ì¢Œìš° ê¸°ìš¸ê¸°
    pitch = e.beta || 0;   // ìƒí•˜ ê¸°ìš¸ê¸°
    yaw = e.alpha || 0;    // ë°©í–¥ (0~360)

    document.getElementById("angle").innerText =
        `roll=${roll.toFixed(1)}  pitch=${pitch.toFixed(1)}  yaw=${yaw.toFixed(1)}`;
});

// -------------------------------
// 3) STREETVIEW + IMU ì ìš©í•œ ì…”í„°
// -------------------------------
function shoot(){
    if(lat === null || lon === null){
        updateStatus("GPS ì¤€ë¹„ì¤‘...");
        return;
    }
    updateStatus("ğŸš— ìŠ¤íŠ¸ë¦¬íŠ¸ë·° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");

    // heading = yawê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì •ê·œí™”)
    let heading = (yaw + 360) % 360;
    // pitchëŠ” -90~90ë§Œ í—ˆìš© ê°€ëŠ¥
    let pitch_v = Math.max(-90, Math.min(90, pitch));

    // ìŠ¤íŠ¸ë¦¬íŠ¸ë·° API
    let url =
    `https://maps.googleapis.com/maps/api/streetview?size=400x400` +
    `&location=${lat},${lon}` +
    `&heading=${heading}` +
    `&pitch=${pitch_v}` +
    `&fov=90` +
    `&key=${API_KEY}`;

    img.src = url;

    img.onload = ()=>{
        updateStatus("ğŸ› ê¸°ìš¸ê¸°(roll) ë Œë”ë§ ì¤‘...");
        drawWithRoll();
    };

    img.onerror = ()=>{
        updateStatus("âŒ ë¡œë”© ì‹¤íŒ¨ (StreetView API ê¶Œí•œ í™•ì¸)");
    };
}

// -------------------------------
// 4) ë¡¤(roll) íšŒì „ ë³´ì • (ìŠ¤íŠ¸ë¦¬íŠ¸ë·°ì—” roll ë§¤ê°œë³€ìˆ˜ ì—†ìŒ)
// -------------------------------
function drawWithRoll(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.save();

    // ìº”ë²„ìŠ¤ ì¤‘ì•™ì„ ê¸°ì¤€ìœ¼ë¡œ roll ì ìš©
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.rotate(roll * Math.PI/180);

    ctx.drawImage(img, -canvas.width/2, -canvas.height/2, canvas.width, canvas.height);

    ctx.restore();

    updateStatus("ğŸ“· ì™„ë£Œ");
}

initGPS();
</script>

</body>
</html>
