<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StreetView TimeMachine â€“ Year Only</title>

<style>
body { margin:0; background:#111; color:white; text-align:center; font-family:sans-serif; }
button {
  margin-top:12px;
  padding:12px 22px;
  font-size:18px;
  background:#444;
  border:none;
  border-radius:10px;
  color:white;
}
#canvas {
  margin-top:15px;
  border-radius:12px;
  background:black;
}
select {
  margin-top:12px;
  padding:12px;
  width:70%;
  font-size:18px;
  border-radius:10px;
  border:none;
}
</style>
</head>

<body>

<h2>ğŸ•’ StreetView TimeMachine â€“ ì—°ë„ ì„ íƒ</h2>
<h3 id="status">GPS ë¡œë”©ì¤‘â€¦</h3>

<!-- ì—°ë„ë§Œ ì„ íƒ -->
<select id="yearPicker">
  <option>ì—°ë„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</option>
</select>

<button onclick="capture()">ğŸ“¸ ìº¡ì²˜</button>

<canvas id="canvas" width="1024" height="1024"></canvas>

<h3 id="angle">roll=0 pitch=0 yaw=0</h3>

<script>
// ----------------------------------------------------
// CONFIG
// ----------------------------------------------------
const API_KEY = "YOUR_API_KEY_HERE";  // â† ë„¤ í‚¤ ë„£ê¸°

// (GPS ì‹¤íŒ¨ ëŒ€ë¹„) ì„œìš¸ ì‹œì²­
const SAFE_LAT = 37.5662952;
const SAFE_LON = 126.9779451;

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let roll=0, pitch=0, yaw=0;
let panoList = [];
let selectedPano = null;

// ----------------------------------------------------
// Device Orientation
// ----------------------------------------------------
window.addEventListener("deviceorientation", e=>{
    roll = e.gamma || 0;
    pitch = e.beta || 0;
    yaw = e.alpha || 0;

    document.getElementById("angle").innerText =
        `roll=${roll.toFixed(1)} pitch=${pitch.toFixed(1)} yaw=${yaw.toFixed(1)}`;
});

// ----------------------------------------------------
// GPS ë°›ê¸°
// ----------------------------------------------------
navigator.geolocation.getCurrentPosition(async pos=>{
    let la = pos.coords.latitude;
    let lo = pos.coords.longitude;

    if(!la || !lo){
        la = SAFE_LAT;
        lo = SAFE_LON;
    }

    document.getElementById("status").innerText =
        `GPS í™•ì¸ â†’ StreetView ìŠ¤ìº”ì¤‘â€¦`;

    await scanPanos(la, lo);

}, async err=>{
    document.getElementById("status").innerText =
        "GPS ì‹¤íŒ¨ â†’ fallback ì¢Œí‘œ ì‚¬ìš©";

    await scanPanos(SAFE_LAT, SAFE_LON);
});

// ----------------------------------------------------
// pano ëª©ë¡ ìˆ˜ì§‘
// ----------------------------------------------------
async function scanPanos(lat, lon){

    // ì£¼ë³€ 7x7 ì˜ì—­ ìƒ˜í”Œ
    const attempts = [];
    const offsets=[0,0.0002,-0.0002,0.0004,-0.0004,0.0006,-0.0006];

    for(let dx of offsets){
        for(let dy of offsets){
            attempts.push([lat+dx, lon+dy]);
        }
    }

    panoList = [];

    for(let p of attempts){
        let meta = await getPanoMeta(p[0], p[1]);
        if(meta && meta.status==="OK"){
            panoList.push({
                pano_id: meta.pano_id,
                lat: meta.location.lat,
                lon: meta.location.lng,
                date: meta.date   // YYYY-MM
            });
        }
    }

    // ì¤‘ë³µ ì œê±°
    panoList = [...new Map(panoList.map(p=>[p.pano_id, p])).values()];

    if(panoList.length === 0){
        document.getElementById("status").innerText =
            "ì´ ìœ„ì¹˜ì—ëŠ” StreetViewê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
    }

    document.getElementById("status").innerText =
        `StreetView ${panoList.length}ê°œ ë°œê²¬ â†’ ì—°ë„ ìƒì„±ì¤‘`;

    populateYearPicker();
    startRendering();
}

// ----------------------------------------------------
// StreetView metadata
// ----------------------------------------------------
async function getPanoMeta(lat, lon){
    const url =
      `https://maps.googleapis.com/maps/api/streetview/metadata?location=${lat},${lon}&key=${API_KEY}`;
    const r = await fetch(url);
    return await r.json();
}

// ----------------------------------------------------
// ì—°ë„ ì„ íƒì°½ ìë™ ìƒì„±
// ----------------------------------------------------
function populateYearPicker(){

    const yearSet = new Set();

    panoList.forEach(p=>{
        const y = p.date.split("-")[0];
        yearSet.add(y);
    });

    const years = [...yearSet].sort();

    const picker = document.getElementById("yearPicker");
    picker.innerHTML = "";

    years.forEach(y=>{
        const op = document.createElement("option");
        op.value = y;
        op.innerText = `${y}ë…„`;
        picker.appendChild(op);
    });

    picker.onchange = pickPano;
}

// ----------------------------------------------------
// ì„ íƒí•œ ì—°ë„ì— í•´ë‹¹í•˜ëŠ” pano ì„ íƒ
// ----------------------------------------------------
function pickPano(){
    const y = document.getElementById("yearPicker").value;
    if(!y) return;

    let best=null;

    panoList.forEach(p=>{
        if(p.date.startsWith(y)) best = p;
    });

    if(best) selectedPano = best;
}

// ----------------------------------------------------
// ë Œë”ë§ ë£¨í”„
// ----------------------------------------------------
function startRendering(){
    setInterval(renderFrame, 200);
}

function renderFrame(){
    if(!selectedPano) selectedPano = panoList[0];

    const heading = (yaw+360)%360;
    const pitch_v = Math.max(-90, Math.min(90, pitch));

    const url =
        `https://maps.googleapis.com/maps/api/streetview?size=2048x2048`+
        `&pano=${selectedPano.pano_id}`+
        `&heading=${heading}`+
        `&pitch=${pitch_v}`+
        `&fov=90&key=${API_KEY}`;

    const img = new Image();
    img.src=url;

    img.onload=()=>{
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.save();
        ctx.translate(canvas.width/2,canvas.height/2);
        ctx.rotate(roll*Math.PI/180);
        ctx.drawImage(img,-canvas.width/2,-canvas.height/2,canvas.width,canvas.height);
        ctx.restore();

        document.getElementById("status").innerText =
            `ğŸ“¸ ${selectedPano.date} | pano=${selectedPano.pano_id}`;
    };
}

// ----------------------------------------------------
// Capture
// ----------------------------------------------------
function capture(){
    let url = canvas.toDataURL("image/png");
    let a = document.createElement("a");
    a.href=url;
    a.download="capture.png";
    a.click();
}
</script>

</body>
</html>
