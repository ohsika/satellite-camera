<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Nearest StreetView Auto Camera</title>

<style>
body { margin:0; background:#111; color:white; text-align:center; font-family:sans-serif; }
button {
  margin-top:20px;
  padding:15px 25px;
  font-size:20px;
  background:#333;
  border:none;
  border-radius:10px;
  color:white;
}
canvas { margin-top:20px; border-radius:10px; }
h3 { margin-top:10px; color:#ccc; font-size:16px; }
</style>
</head>

<body>

<h2>ğŸ“¡ Auto StreetView Camera (Nearest Panorama)</h2>
<h3 id="status">ğŸ“ GPS ìœ„ì¹˜ ì–»ëŠ” ì¤‘...</h3>

<button onclick="shoot()">ğŸ“· ì…”í„°</button>

<canvas id="canvas" width="400" height="400"></canvas>

<h3 id="angle">roll=0 pitch=0 yaw=0</h3>

<script>
const API_KEY = "AIzaSyCJwQpLT9pLj_zZIfFVN007MDOPnTqs5Gs";  // â† ë„ˆ API í‚¤

let lat=null, lon=null;
let roll=0, pitch=0, yaw=0;
let canvas=document.getElementById("canvas");
let ctx=canvas.getContext("2d");
let img=new Image();

function updateStatus(msg){ 
    document.getElementById("status").innerText = msg; 
}

// -------------------------------
// 1) GPS ì–»ê¸°
// -------------------------------
function initGPS(){
    if (!navigator.geolocation){
        updateStatus("âŒ GPS ì§€ì› ì•ˆë¨");
        return;
    }
    navigator.geolocation.getCurrentPosition(
        pos=>{
            lat=pos.coords.latitude;
            lon=pos.coords.longitude;
            updateStatus(`ìœ„ì¹˜ OK: ${lat.toFixed(5)}, ${lon.toFixed(5)}`);
        },
        err=>{
            updateStatus("âŒ GPS ê¶Œí•œ ê±°ë¶€ë¨");
        },
        {enableHighAccuracy:true}
    );
}

// -------------------------------
// 2) ìì´ë¡œ ì½ê¸°
// -------------------------------
window.addEventListener("deviceorientation", e=>{
    roll=e.gamma||0;
    pitch=e.beta||0;
    yaw=e.alpha||0;

    document.getElementById("angle").innerText =
        `roll=${roll.toFixed(1)} pitch=${pitch.toFixed(1)} yaw=${yaw.toFixed(1)}`;
});

// -------------------------------
// 3) í•´ë‹¹ ìœ„ì¹˜ì— StreetView ìˆëŠ”ì§€ í™•ì¸
// -------------------------------
async function getStreetViewMeta(lat, lon){
    let url =
    `https://maps.googleapis.com/maps/api/streetview/metadata?location=${lat},${lon}&key=${API_KEY}`;
    let res = await fetch(url);
    return await res.json();
}

// -------------------------------
// 4) ì£¼ë³€ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ StreetView íƒìƒ‰
// ë°˜ê²½ 5m â†’ 15m â†’ 30m â†’ 50m â†’ 100m â†’ ... 300mê¹Œì§€ ì¦ê°€
// -------------------------------
async function findNearestStreetView(lat, lon){
    const radii = [5, 15, 30, 50, 100, 200, 300];

    for(let r of radii){
        let url =
        `https://maps.googleapis.com/maps/api/streetview/metadata?` +
        `location=${lat},${lon}&radius=${r}&key=${API_KEY}`;

        let res = await fetch(url);
        let meta = await res.json();

        if(meta.status==="OK"){
            return { 
                pano_id: meta.pano_id,
                lat: meta.location.lat,
                lon: meta.location.lng,
                radius: r
            };
        }
    }
    return null;
}

// -------------------------------
// 5) ì…”í„°: StreetView ìˆìœ¼ë©´ ë°”ë¡œ, ì—†ìœ¼ë©´ ê·¼ì²˜ ìë™íƒìƒ‰
// -------------------------------
async function shoot(){
    if(lat===null || lon===null){
        updateStatus("GPS ì¤€ë¹„ì¤‘...");
        return;
    }

    updateStatus("ğŸ” ìŠ¤íŠ¸ë¦¬íŠ¸ë·° ê²€ìƒ‰ ì¤‘...");

    let meta = await getStreetViewMeta(lat, lon);

    let target_lat = lat;
    let target_lon = lon;
    let infoText = "";

    if(meta.status!=="OK"){
        updateStatus("âŒ í˜„ì¬ ìœ„ì¹˜ì— ìŠ¤íŠ¸ë¦¬íŠ¸ë·° ì—†ìŒ â†’ ì£¼ë³€ íƒìƒ‰ ì¤‘...");

        let near = await findNearestStreetView(lat, lon);

        if(!near){
            updateStatus("âŒ ì£¼ë³€ 300m ë‚´ ìŠ¤íŠ¸ë¦¬íŠ¸ë·° ì—†ìŒ (ìœ„ì„± í•„ìš”)");
            return;
        }

        target_lat = near.lat;
        target_lon = near.lon;

        infoText = `ğŸ“ ê·¼ì²˜ ìŠ¤íŠ¸ë¦¬íŠ¸ë·° ì‚¬ìš© (${near.radius}m ì´ë‚´)`;

    } else {
        infoText = "ğŸ“ í˜„ì¬ ìœ„ì¹˜ ìŠ¤íŠ¸ë¦¬íŠ¸ë·°";
    }

    let heading = (yaw+360)%360;
    let pitch_v = Math.max(-90, Math.min(90, pitch));

    let url =
    `https://maps.googleapis.com/maps/api/streetview?size=400x400` +
    `&location=${target_lat},${target_lon}` +
    `&heading=${heading}` +
    `&pitch=${pitch_v}` +
    `&fov=90` +
    `&key=${API_KEY}`;

    img.src=url;

    img.onload=()=>{
        ctx.clearRect(0,0,canvas.width,canvas.height);

        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2);
        ctx.rotate(roll*Math.PI/180);
        ctx.drawImage(img,-canvas.width/2,-canvas.height/2,canvas.width,canvas.height);
        ctx.restore();

        updateStatus(infoText+"  âœ” ì™„ë£Œ");
    };

    img.onerror=()=>{
        updateStatus("âŒ ë¡œë”© ì‹¤íŒ¨ (API or ë„¤íŠ¸ì›Œí¬ í™•ì¸)");
    };
}

initGPS();
</script>

</body>
</html>
