<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TimeMachine StreetView Live Camera â€“ Stable</title>

<style>
body { margin:0; background:#111; color:white; text-align:center; font-family:sans-serif; }
button {
  margin-top:12px;
  padding:12px 22px;
  font-size:18px;
  background:#444;
  border:none;
  border-radius:10px;
  color:white;
}
#canvas {
  margin-top:15px;
  border-radius:12px;
  background:black;
}
input {
  margin-top:10px;
  padding:8px;
  border-radius:8px;
  width:60%;
  font-size:16px;
  border:none;
}
</style>
</head>

<body>

<h2>ğŸ“¡ TimeMachine StreetView Live Camera â€“ Stable</h2>
<h3 id="status">GPS ë¡œë”©ì¤‘â€¦</h3>

<input type="date" id="datePicker">
<button onclick="capture()">ğŸ“¸ ìº¡ì²˜</button>

<canvas id="canvas" width="1024" height="1024"></canvas>

<h3 id="angle">roll=0 pitch=0 yaw=0</h3>

<script>
// =====================================================
// CONFIG
// =====================================================
const API_KEY = "AIzaSyCJwQpLT9pLj_zZIfFVN007MDOPnTqs5Gs";   // ë„ˆì˜ ì‹¤ì œ í‚¤
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

// ë„ë¡œ ìŠ¤ìº”ì´ ì‹¤íŒ¨í•  ê²½ìš° fallback ì¢Œí‘œ(ì„œìš¸ ì‹œì²­)
const SAFE_LAT = 37.5662952;
const SAFE_LON = 126.9779451;

// orientation
let roll=0, pitch=0, yaw=0;

// pano list
let panoList = [];
let selectedPano = null;

// =====================================================
// 1) Device Orientation
// =====================================================
window.addEventListener("deviceorientation", e=>{
    roll = e.gamma || 0;
    pitch = e.beta || 0;
    yaw = e.alpha || 0;
    document.getElementById("angle").innerText =
        `roll=${roll.toFixed(1)} pitch=${pitch.toFixed(1)} yaw=${yaw.toFixed(1)}`;
});

// =====================================================
// 2) GPS + ì•ˆì •ì  ìŠ¤ìº”
// =====================================================
navigator.geolocation.getCurrentPosition(async pos=>{
    let la = pos.coords.latitude;
    let lo = pos.coords.longitude;

    // GPS ë³´ì • (ì‹¤ë‚´/ê±´ë¬¼ì¼ ë•Œ ë°”ë¡œ fallback)
    if(isNaN(la) || isNaN(lo)) {
        la = SAFE_LAT;
        lo = SAFE_LON;
    }

    document.getElementById("status").innerText =
        `GPS ìœ„ì¹˜ ê°ì§€ë¨: ${la.toFixed(5)}, ${lo.toFixed(5)} â†’ ë„ë¡œ ìŠ¤ìº”ì¤‘`;

    await loadNearbyPanos(la, lo);

}, async err=>{

    // GPS ì „ì²´ ì‹¤íŒ¨ â†’ fallback ì¢Œí‘œë¡œ ì§„í–‰
    document.getElementById("status").innerText =
        "GPS ì‹¤íŒ¨ â†’ ì„œìš¸ ì¤‘ì‹¬ì¢Œí‘œ ì‚¬ìš©";

    await loadNearbyPanos(SAFE_LAT, SAFE_LON);
});

// =====================================================
// 3) pano ë¶ˆëŸ¬ì˜¤ê¸° (ì•ˆì •íŒ)
// =====================================================
async function loadNearbyPanos(lat, lon){

    // âŠ StreetView metadata ì§ì ‘ ìŠ¤ìº” (ë„ë¡œ ì‹¤íŒ¨í•´ë„ ì‘ë™)
    const url =
      `https://maps.googleapis.com/maps/api/streetview/metadata?location=${lat},${lon}&key=${API_KEY}`;

    const res = await fetch(url);
    const meta = await res.json();

    if(meta.status !== "OK"){
        document.getElementById("status").innerText =
            `StreetView ì—†ìŒ â†’ fallback ì‚¬ìš©`;

        // ì¤‘ì‹¬ ì¢Œí‘œë¡œ fallback metadata
        await loadFallbackPano();
        startRendering();
        return;
    }

    panoList = [{
        pano_id: meta.pano_id,
        lat: meta.location.lat,
        lon: meta.location.lng,
        date: meta.date
    }];

    document.getElementById("status").innerText =
        `pano 1ê°œ í™•ë³´ë¨: ${meta.pano_id} (${meta.date})`;

    startRendering();
}

// =====================================================
// 4) fallback pano (í•­ìƒ ì¡´ì¬í•˜ëŠ” ì¢Œí‘œ)
// =====================================================
async function loadFallbackPano(){
    const url =
      `https://maps.googleapis.com/maps/api/streetview/metadata?location=${SAFE_LAT},${SAFE_LON}&key=${API_KEY}`;

    const res = await fetch(url);
    const meta = await res.json();

    panoList = [{
        pano_id: meta.pano_id,
        lat: meta.location.lat,
        lon: meta.location.lng,
        date: meta.date
    }];
}

// =====================================================
// 5) ë‚ ì§œ ì„ íƒ (ì„ íƒ ì•ˆí•˜ë©´ ê·¸ëƒ¥ 1ê°œ ì‚¬ìš©)
// =====================================================
function pickPano(){
    if(panoList.length === 0) return null;
    if(panoList.length === 1) return panoList[0];

    let dateVal = document.getElementById("datePicker").value;
    if(!dateVal) return panoList[0];

    const target = dateVal.slice(0,7);

    let best=null, bestDiff=1e20;

    panoList.forEach(p=>{
        let d1 = Date.parse(p.date+"-01");
        let d2 = Date.parse(target+"-01");
        let diff = Math.abs(d1-d2);
        if(diff<bestDiff){
            bestDiff=diff;
            best=p;
        }
    });

    return best;
}

// =====================================================
// 6) ë Œë”ë§ ë£¨í”„
// =====================================================
function startRendering(){
    setInterval(()=>renderFrame(), 200);
}

function renderFrame(){

    selectedPano = pickPano();
    if(!selectedPano) return;

    let heading = (yaw+360)%360;
    let pitch_v = Math.max(-90, Math.min(90, pitch));

    let url =
        `https://maps.googleapis.com/maps/api/streetview?size=2048x2048`+
        `&pano=${selectedPano.pano_id}`+
        `&heading=${heading}`+
        `&pitch=${pitch_v}`+
        `&fov=90`+
        `&key=${API_KEY}`;

    let img = new Image();
    img.src=url;

    img.onload=()=>{
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2);
        ctx.rotate(roll * Math.PI/180);
        ctx.drawImage(img,-canvas.width/2,-canvas.height/2,canvas.width,canvas.height);
        ctx.restore();

        document.getElementById("status").innerText =
            `ğŸ“¸ pano=${selectedPano.pano_id} | ${selectedPano.date}`;
    };

    img.onerror = ()=>{
        document.getElementById("status").innerText =
            `ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ â†’ ì¬ì‹œë„ì¤‘â€¦`;
    };
}

// =====================================================
// 7) ìº¡ì²˜
// =====================================================
function capture(){
    let url = canvas.toDataURL("image/png");
    let a = document.createElement("a");
    a.href=url;
    a.download="capture.png";
    a.click();
}

</script>

</body>
</html>
