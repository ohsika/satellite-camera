<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StreetView Camera â€“ Final Stable Version</title>

<style>
body { margin:0; background:#111; color:white; text-align:center; font-family:sans-serif; }
.btn {
  margin-top:12px; padding:12px 22px;
  font-size:18px; background:#444;
  border:none; border-radius:10px; color:white;
  cursor:pointer;
}
#canvas {
  margin-top:15px; border-radius:12px;
  background:black; max-width:95%;
}
select {
  margin-top:12px; padding:12px;
  width:70%; font-size:18px;
  border-radius:10px; border:none;
}
</style>
</head>

<body>

<h2>ğŸ“¸ StreetView TimeMachine â€“ PC Final Version</h2>
<h3 id="status">ë¡œë“œ ì¤‘â€¦</h3>

<select id="yearPicker">
  <option>ì—°ë„ ë¡œë”©ì¤‘â€¦</option>
</select>

<br>
<button class="btn" onclick="capture()">ğŸ“¥ ìº¡ì²˜</button>

<canvas id="canvas" width="1024" height="1024"></canvas>

<script>
// =============================================
// CONFIG
// =============================================
const API_KEY = "YOUR_API_KEY_HERE"; // ë°˜ë“œì‹œ ë„£ê¸°

// PC: ê¸°ìš¸ê¸° ì„¼ì„œ ì—†ìŒ â†’ ë§ˆìš°ìŠ¤ë¡œ ì‹œì  íšŒì „ ì§€ì›
let heading = 0;     // ì¢Œìš° íšŒì „
let pitch   = 0;     // ìƒí•˜ íšŒì „

let panoList = [];
let selected = null;

// =============================================
// ë§ˆìš°ìŠ¤ë¡œ ì‹œì  íšŒì „
// =============================================
let dragging=false, lastX=0, lastY=0;
document.addEventListener("mousedown", e=>{ dragging=true; lastX=e.clientX; lastY=e.clientY; });
document.addEventListener("mouseup", ()=>dragging=false);
document.addEventListener("mousemove", e=>{
  if(!dragging) return;
  const dx = e.clientX - lastX;
  const dy = e.clientY - lastY;
  lastX = e.clientX;
  lastY = e.clientY;

  heading = (heading + dx*0.2) % 360;
  pitch   = Math.max(-90, Math.min(90, pitch - dy*0.2));
});

// =============================================
// 1km GRID ìƒì„± í›„ StreetView pano ìë™ ê²€ìƒ‰
// =============================================
async function startScan(){
  // PCì—ì„œëŠ” GPS ëŒ€ì‹  ì„œìš¸ì‹œì²­ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì”€
  const lat0 = 37.5663;
  const lon0 = 126.9779;

  document.getElementById("status").innerText = "ğŸ“¡ ì£¼ë³€ 1km StreetView ìŠ¤ìº”ì¤‘â€¦";

  const latOffsets = [];
  const lonOffsets = [];

  for(let i=-10;i<=10;i++){
    latOffsets.push(i * 0.0009);   // ì•½ 100m
    lonOffsets.push(i * 0.00115);  // ì•½ 100m
  }

  const points = [];
  for(let dx of latOffsets)
  for(let dy of lonOffsets)
    points.push([lat0+dx, lon0+dy]);

  panoList = [];

  for(let p of points){
    const meta = await getMeta(p[0], p[1]);
    if(meta && meta.status==="OK"){
      panoList.push({
        pano_id: meta.pano_id,
        date: meta.date
      });
    }
  }

  panoList = [...new Map(panoList.map(p=>[p.pano_id,p])).values()];

  if(panoList.length===0){
    document.getElementById("status").innerText = "âŒ ì£¼ë³€ 1km StreetView ì—†ìŒ";
    return;
  }

  document.getElementById("status").innerText =
    `âœ” ${panoList.length}ê°œ pano ë°œê²¬ â†’ ì—°ë„ ëª©ë¡ êµ¬ì„±ì¤‘`;

  populateYears();
  renderLoop();
}

// =============================================
async function getMeta(lat, lon){
  const url =
    `https://maps.googleapis.com/maps/api/streetview/metadata?location=${lat},${lon}&key=${API_KEY}`;
  try {
    const r = await fetch(url);
    return await r.json();
  } catch(e){
    console.log("metadata error", e);
    return null;
  }
}

// =============================================
function populateYears(){
  const set = new Set();
  panoList.forEach(p=> set.add(p.date.split("-")[0]) );
  const years = [...set].sort();

  const picker = document.getElementById("yearPicker");
  picker.innerHTML = "";
  years.forEach(y=>{
    const op = document.createElement("option");
    op.value = y;
    op.innerText = `${y}ë…„`;
    picker.appendChild(op);
  });

  picker.onchange = ()=>{
    const y = picker.value;
    panoList.forEach(p=>{
      if(p.date.startsWith(y)) selected = p;
    });
  };

  selected = panoList[0]; // ì´ˆê¸°ê°’
}

// =============================================
function renderLoop(){
  setInterval(renderFrame, 150);
}

function renderFrame(){
  if(!selected) return;

  const img = new Image();
  img.crossOrigin = "Anonymous";
  img.src =
    `https://maps.googleapis.com/maps/api/streetview?size=1024x1024`+
    `&pano=${selected.pano_id}`+
    `&heading=${heading}`+
    `&pitch=${pitch}`+
    `&fov=90&key=${API_KEY}`;

  img.onload = ()=>{
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    ctx.clearRect(0,0,1024,1024);
    ctx.drawImage(img,0,0,1024,1024);

    document.getElementById("status").innerText =
      `ğŸ“¸ ${selected.date} | heading=${heading.toFixed(1)}, pitch=${pitch.toFixed(1)}`;
  };
}

// =============================================
function capture(){
  const url = document.getElementById("canvas").toDataURL("image/png");
  const a = document.createElement("a");
  a.href = url;
  a.download = "capture.png";
  a.click();
}

// =============================================
startScan();

</script>
</body>
</html>
