<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TimeMachine StreetView Live Camera PRO</title>

<style>
body { margin:0; background:#111; color:white; text-align:center; font-family:sans-serif; }
button {
  margin-top:12px;
  padding:12px 22px;
  font-size:18px;
  background:#444;
  border:none;
  border-radius:10px;
  color:white;
}
#canvas {
  margin-top:15px;
  border-radius:12px;
  background:black;
}
input {
  margin-top:10px;
  padding:8px;
  border-radius:8px;
  width:60%;
  font-size:16px;
  border:none;
}
</style>
</head>

<body>

<h2>ğŸ•’ TimeMachine StreetView Live Camera PRO</h2>
<h3 id="status">GPS ë¡œë”©ì¤‘...</h3>

<input type="date" id="datePicker">
<button onclick="capture()">ğŸ“¸ ìº¡ì²˜</button>

<canvas id="canvas" width="1024" height="1024"></canvas>

<h3 id="angle">roll=0 pitch=0 yaw=0</h3>

<script>
// ===========================
// CONFIG
// ===========================
const API_KEY = "<<YOUR_API_KEY>>";   // â† ì—¬ê¸° ë„£ê¸°
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

// ë„ë¡œ ìŠ¤ëƒ… ìƒ˜í”Œ ê°„ê²© (ë¯¸í„°)
const SAMPLE_INTERVAL = 10;
const SEARCH_RADIUS_METERS = 1000; // 1km ê²€ìƒ‰

// GPS / IMU
let lat=null, lon=null;
let roll=0, pitch=0, yaw=0;

// Pano List: {pano_id, lat, lon, date}
let panoList = [];
let selectedPano = null;

// ===========================
// 1) GPS
// ===========================
navigator.geolocation.getCurrentPosition(async pos=>{
    lat = pos.coords.latitude;
    lon = pos.coords.longitude;
    document.getElementById("status").innerText = `GPS OK: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
    await scanAllRoads();
}, err=>{
    document.getElementById("status").innerText = "âŒ GPS ê¶Œí•œ ì—†ìŒ";
});

// ===========================
// 2) Orientation
// ===========================
window.addEventListener("deviceorientation", e=>{
    roll = e.gamma || 0;
    pitch = e.beta || 0;
    yaw = e.alpha || 0;

    document.getElementById("angle").innerText =
        `roll=${roll.toFixed(1)} pitch=${pitch.toFixed(1)} yaw=${yaw.toFixed(1)}`;
});

// ===========================
// 3) Google Roads API â€“ ë„ë¡œ ì¢Œí‘œ ìˆ˜ì§‘
// ===========================
async function snapToRoads(latArr, lonArr) {
    const points = latArr.map((la, i)=>`${la},${lonArr[i]}`).join("|");
    const url = 
      `https://roads.googleapis.com/v1/snapToRoads?path=${points}&interpolate=true&key=${API_KEY}`;
    
    const res = await fetch(url);
    return await res.json();
}

// ë¼ë””ì•ˆ ë³€í™˜
function toRad(deg){ return deg * Math.PI/180; }

// ê±°ë¦¬ = haversine
function distance(lat1, lon1, lat2, lon2) {
    const R=6371000;
    const dLat=toRad(lat2-lat1);
    const dLon=toRad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// ì›í˜•ìœ¼ë¡œ ì¢Œí‘œ ë¿Œë¦¬ê¸°
function generateSearchRing(centerLat, centerLon, radius) {
    const pts = [];
    for(let ang=0; ang<360; ang+=20){
        const rad = toRad(ang);
        const dLat = (radius/111111)*Math.cos(rad);
        const dLon = (radius/(111111*Math.cos(toRad(centerLat))))*Math.sin(rad);
        pts.push([centerLat+dLat, centerLon+dLon]);
    }
    return pts;
}

// ===========================
// 4) ì£¼ë³€ ëª¨ë“  ë„ë¡œ ìˆ˜ì§‘ + pano_id ìŠ¤ìº”
// ===========================
async function scanAllRoads(){

    document.getElementById("status").innerText = "ğŸ“¡ RoadsAPI: ë„ë¡œ ìŠ¤ìº”ì¤‘...";

    let rawRoadPoints = [];

    for(let radius=50; radius<=SEARCH_RADIUS_METERS; radius+=200){
        const ring = generateSearchRing(lat, lon, radius);

        for(let pt of ring){
            rawRoadPoints.push(pt);
        }
    }

    // ë„ë¡œ ìŠ¤ëƒ…
    let snapped = await snapToRoads(
        rawRoadPoints.map(p=>p[0]),
        rawRoadPoints.map(p=>p[1])
    );

    if(!snapped.snappedPoints){
        document.getElementById("status").innerText = "âŒ RoadsAPI ì‹¤íŒ¨";
        return;
    }

    // ë„ë¡œ ì¢Œí‘œ ìˆ˜ì§‘
    let roadCoords = snapped.snappedPoints.map(p=>[
        p.location.latitude,
        p.location.longitude
    ]);

    // ê°„ê²©ì„ 10më¡œ ì¤„ì´ê¸° ìœ„í•´ ë³´ê°„
    let sampled = [];
    for(let i=0;i<roadCoords.length-1;i++){
        let [aLat, aLon] = roadCoords[i];
        let [bLat, bLon] = roadCoords[i+1];
        let dist = distance(aLat,aLon,bLat,bLon);
        let steps = Math.ceil(dist / SAMPLE_INTERVAL);
        for(let s=0;s<=steps;s++){
            let t = s/steps;
            sampled.push([
                aLat + (bLat-aLat)*t,
                aLon + (bLon-aLon)*t
            ]);
        }
    }

    document.getElementById("status").innerText = `ğŸ“ ë„ë¡œìƒ˜í”Œ ${sampled.length}ê°œ â†’ pano ìŠ¤ìº”ì¤‘`;

    // pano metadata ìˆ˜ì§‘
    panoList = [];
    for(let pt of sampled){
        let meta = await getPanoByLocation(pt[0], pt[1]);
        if(meta && meta.status==="OK"){
            panoList.push({
                pano_id: meta.pano_id,
                lat: meta.location.lat,
                lon: meta.location.lng,
                date: meta.date
            });
        }
    }

    // ì¤‘ë³µ ì œê±°
    panoList = [...new Map(panoList.map(p=>[p.pano_id, p])).values()];

    document.getElementById("status").innerText =
        `âœ” pano ìˆ˜ì§‘ ì™„ë£Œ: ${panoList.length}ê°œ`;

    startLiveView();
}

async function getPanoByLocation(la, lo){
    let url = 
      `https://maps.googleapis.com/maps/api/streetview/metadata?location=${la},${lo}&key=${API_KEY}`;
    let r = await fetch(url);
    return await r.json();
}

// ===========================
// 5) ë‚ ì§œì— ë§ì¶° pano ì„ íƒ
// ===========================
function pickPano(){
    if(panoList.length===0) return null;

    let dateVal = document.getElementById("datePicker").value;
    if(!dateVal) return panoList[0];

    const target = dateVal.slice(0,7);

    let best=null, bestDiff=1e20;

    panoList.forEach(p=>{
        let d1 = Date.parse(p.date+"-01");
        let d2 = Date.parse(target+"-01");
        let diff = Math.abs(d1-d2);
        if(diff<bestDiff){
            bestDiff=diff;
            best=p;
        }
    });

    return best;
}

// ===========================
// 6) ì‹¤ì‹œê°„ StreetView ë Œë”ë§
// ===========================
function startLiveView(){
    setInterval(()=>renderFrame(), 200);
}

function renderFrame(){
    selectedPano = pickPano();
    if(!selectedPano) return;

    let heading = (yaw+360)%360;
    let pitch_v = Math.max(-90, Math.min(90, pitch));

    let url =
        `https://maps.googleapis.com/maps/api/streetview?size=2048x2048`+
        `&pano=${selectedPano.pano_id}`+
        `&heading=${heading}`+
        `&pitch=${pitch_v}`+
        `&fov=90`+
        `&key=${API_KEY}`;

    let img = new Image();
    img.src=url;

    img.onload=()=>{
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2);
        ctx.rotate(roll * Math.PI/180);
        ctx.drawImage(img,-canvas.width/2,-canvas.height/2,canvas.width,canvas.height);
        ctx.restore();

        document.getElementById("status").innerText =
            `ğŸ“¸ pano=${selectedPano.pano_id} | date=${selectedPano.date}`;
    };
}

// ===========================
// 7) ìº¡ì²˜ ì €ì¥
// ===========================
function capture(){
    let url = canvas.toDataURL("image/png");
    let a = document.createElement("a");
    a.href=url;
    a.download="capture.png";
    a.click();
}
</script>

</body>
</html>
