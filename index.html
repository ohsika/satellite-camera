<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TimeMachine StreetView Live Camera</title>

<style>
body { margin:0; background:#111; color:white; text-align:center; font-family:sans-serif; }
button {
  margin-top:15px;
  padding:12px 20px;
  font-size:18px;
  background:#444;
  border:none;
  border-radius:10px;
  color:white;
}
#canvas {
  margin-top:15px;
  border-radius:12px;
  background:black;
}
input {
  margin-top:10px;
  padding:8px;
  border-radius:8px;
  width:60%;
  font-size:16px;
  border:none;
}
</style>
</head>

<body>

<h2>ðŸ•’ TimeMachine StreetView Live Camera</h2>
<h3 id="status">GPS ì–»ëŠ” ì¤‘...</h3>

<input type="date" id="datePicker">

<button onclick="capture()">ðŸ“¸ ìº¡ì²˜ ì €ìž¥</button>

<canvas id="canvas" width="1024" height="1024"></canvas>

<h3 id="angle">roll=0 pitch=0 yaw=0</h3>

<script>
// ==========================
//  SETTINGS
// ==========================
const API_KEY = "<YOUR_API_KEY>";   // â† ë„ˆì˜ API í‚¤
const SEARCH_RADII = [20, 50, 100, 200, 300, 500];
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let lat=null, lon=null;

// IMU
let roll=0, pitch=0, yaw=0;

// Pano List
let panoList = []; // {pano_id, lat, lon, date}
let selectedPano = null;

// ==========================
// 1) GPS
// ==========================
navigator.geolocation.getCurrentPosition(
 res=>{
   lat=res.coords.latitude;
   lon=res.coords.longitude;
   document.getElementById("status").innerText = `GPS OK: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
   loadPanoList();
 },
 err=>{
   document.getElementById("status").innerText = "âŒ GPS ê±°ë¶€ë¨";
 }
);

// ==========================
// 2) Orientation
// ==========================
window.addEventListener("deviceorientation", e=>{
 roll=e.gamma||0;
 pitch=e.beta||0;
 yaw=e.alpha||0;
 document.getElementById("angle").innerText =
   `roll=${roll.toFixed(1)} pitch=${pitch.toFixed(1)} yaw=${yaw.toFixed(1)}`;
});

// ==========================
// 3) StreetView Metadata
// ==========================
async function getMetaFromLatLon(LA, LO, radius){
 let url = `https://maps.googleapis.com/maps/api/streetview/metadata?location=${LA},${LO}&radius=${radius}&key=${API_KEY}`;
 let r = await fetch(url);
 return await r.json();
}

async function getMetaFromPano(pano_id){
 let url = `https://maps.googleapis.com/maps/api/streetview/metadata?pano=${pano_id}&key=${API_KEY}`;
 let r = await fetch(url);
 return await r.json();
}

// ==========================
// 4) panoID ì „ì²´ ìˆ˜ì§‘
// ==========================
async function loadPanoList(){
 document.getElementById("status").innerText = "ðŸ“¡ ìŠ¤íŠ¸ë¦¬íŠ¸ë·° ë°ì´í„° ìˆ˜ì§‘ì¤‘...";

 let tmp = [];

 for(let R of SEARCH_RADII){
   let meta = await getMetaFromLatLon(lat, lon, R);
   if(meta.status==="OK"){
     tmp.push(meta.pano_id);
   }
 }

 // pano id ì¤‘ë³µ ì œê±°
 tmp = [...new Set(tmp)];

 // ìƒì„¸ ë‚ ì§œ ìˆ˜ì§‘
 panoList = [];

 for(let p of tmp){
   let m = await getMetaFromPano(p);
   if(m.status==="OK"){
     panoList.push({
       pano_id: p,
       lat: m.location.lat,
       lon: m.location.lng,
       date: m.date  // "YYYY-MM"
     });
   }
 }

 if(panoList.length===0){
   document.getElementById("status").innerText = "âŒ ì£¼ë³€ ìŠ¤íŠ¸ë¦¬íŠ¸ë·° ì—†ìŒ";
   return;
 }

 document.getElementById("status").innerText = `ðŸ“ ìˆ˜ì§‘ëœ pano ìˆ˜: ${panoList.length}`;

 startLiveView();
}

// ==========================
// 5) ë‚ ì§œ ì„ íƒ â†’ pano ìžë™ì„ íƒ
// ==========================
function pickPano(){
 let selectedDate = document.getElementById("datePicker").value;
 if(!selectedDate) return panoList[0];

 // YYYY-MM ë¹„êµ
 let target = selectedDate.slice(0,7);
 let best = null;
 let bestDiff = 9999999;

 panoList.forEach(p=>{
   let diff = Math.abs(Date.parse(p.date+"-01") - Date.parse(target+"-01"));
   if(diff < bestDiff){
     bestDiff = diff;
     best = p;
   }
 });

 return best;
}

// ==========================
// 6) ì‹¤ì‹œê°„ í™”ë©´ ì—…ë°ì´íŠ¸
// ==========================
async function startLiveView(){
 document.getElementById("status").innerText = "ðŸŽ¥ ë¼ì´ë¸Œ ìŠ¤íŠ¸ë¦¬íŠ¸ë·° ì‹œìž‘";

 setInterval(()=>{ renderFrame(); }, 200);  // 5fps
}

function renderFrame(){
 if(panoList.length===0) return;

 selectedPano = pickPano();

 let heading = (yaw+360)%360;
 let pitch_v = Math.max(-90, Math.min(90, pitch));

 let url =
   `https://maps.googleapis.com/maps/api/streetview?size=2048x2048`+
   `&pano=${selectedPano.pano_id}`+
   `&heading=${heading}`+
   `&pitch=${pitch_v}`+
   `&fov=90`+
   `&key=${API_KEY}`;

 let img = new Image();
 img.src = url;

 img.onload = ()=>{
   ctx.clearRect(0,0,canvas.width,canvas.height);
   ctx.save();
   ctx.translate(canvas.width/2, canvas.height/2);
   ctx.rotate(roll * Math.PI/180);
   ctx.drawImage(img, -canvas.width/2, -canvas.height/2, canvas.width, canvas.height);
   ctx.restore();
 };

}

// ==========================
// 7) ìº¡ì²˜
// ==========================
function capture(){
 let data = canvas.toDataURL("image/png");
 let a = document.createElement("a");
 a.href = data;
 a.download = "capture.png";
 a.click();
}
</script>

</body>
</html>
