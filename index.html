<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>High-Res StreetView Camera</title>

<style>
body { margin:0; background:#111; color:white; text-align:center; font-family:sans-serif; }
button {
  margin-top:15px;
  padding:15px 25px;
  font-size:20px;
  background:#333;
  border:none;
  border-radius:10px;
  color:white;
}
canvas {
  margin-top:20px;
  border-radius:12px;
  background:#000;
}
input {
  padding:10px;
  border-radius:10px;
  border:none;
  margin-top:15px;
  font-size:18px;
}
h3 { margin-top:10px; color:#ccc; font-size:16px; }
</style>
</head>

<body>

<h2>ğŸ“¡ High-Resolution StreetView Camera</h2>
<h3 id="status">GPS ìœ„ì¹˜ ì–»ëŠ” ì¤‘...</h3>

<input type="date" id="datePicker">

<button onclick="shoot()">ğŸ“· ì…”í„°</button>

<canvas id="canvas" width="1024" height="1024"></canvas>

<h3 id="angle">roll=0 pitch=0 yaw=0</h3>

<script>
const API_KEY = "AIzaSyCJwQpLT9pLj_zZIfFVN007MDOPnTqs5Gs";  // â† í‚¤

let lat=null, lon=null;
let roll=0, pitch=0, yaw=0;
let canvas=document.getElementById("canvas");
let ctx=canvas.getContext("2d");
let img=new Image();

function updateStatus(msg){
    document.getElementById("status").innerText = msg;
}

// -------------------------
// 1. GPS
// -------------------------
function initGPS(){
    if (!navigator.geolocation){
        updateStatus("âŒ GPS ë¯¸ì§€ì›");
        return;
    }
    navigator.geolocation.getCurrentPosition(
        pos=>{
            lat=pos.coords.latitude;
            lon=pos.coords.longitude;
            updateStatus(`ìœ„ì¹˜ OK: ${lat.toFixed(5)}, ${lon.toFixed(5)}`);
        },
        err=>{
            updateStatus("âŒ GPS ê¶Œí•œ ê±°ë¶€ë¨");
        },
        {enableHighAccuracy:true}
    );
}

// -------------------------
// 2. ìì´ë¡œ
// -------------------------
window.addEventListener("deviceorientation", e=>{
    roll=e.gamma||0;
    pitch=e.beta||0;
    yaw=e.alpha||0;
    document.getElementById("angle").innerText =
        `roll=${roll.toFixed(1)} pitch=${pitch.toFixed(1)} yaw=${yaw.toFixed(1)}`;
});

// -------------------------
// 3. ë©”íƒ€ ìš”ì²­
// -------------------------
async function getStreetViewMeta(lat, lon){
    let url =
    `https://maps.googleapis.com/maps/api/streetview/metadata?location=${lat},${lon}&key=${API_KEY}`;
    let res = await fetch(url);
    return await res.json();
}

// -------------------------
// 4. ì£¼ë³€ ìŠ¤íŠ¸ë¦¬íŠ¸ë·° ìë™ íƒìƒ‰
// -------------------------
async function findNearestStreetView(lat, lon){
    const radii=[5,15,30,50,100,200,300];
    for(let r of radii){
        let url =
        `https://maps.googleapis.com/maps/api/streetview/metadata?location=${lat},${lon}&radius=${r}&key=${API_KEY}`;
        let res = await fetch(url);
        let meta = await res.json();
        if(meta.status==="OK"){
            return {
                lat: meta.location.lat,
                lon: meta.location.lng,
                radius: r,
                pano_id: meta.pano_id
            };
        }
    }
    return null;
}

// -------------------------
// 5. ì…”í„°
// -------------------------
async function shoot(){
    if(lat===null||lon===null){
        updateStatus("GPS ì¤€ë¹„ì¤‘...");
        return;
    }

    updateStatus("ğŸ” ìŠ¤íŠ¸ë¦¬íŠ¸ë·° ê²€ìƒ‰ ì¤‘...");

    let pickedDate = document.getElementById("datePicker").value;
    if(!pickedDate) pickedDate = "ìµœê·¼ ë‚ ì§œ"; // í‘œì‹œë§Œ

    let meta = await getStreetViewMeta(lat, lon);

    let target_lat = lat;
    let target_lon = lon;
    let msg="";

    if(meta.status!=="OK"){
        updateStatus("âŒ í˜„ì¬ ìœ„ì¹˜ ì—†ìŒ â†’ ê·¼ì²˜ íƒìƒ‰");

        let near = await findNearestStreetView(lat, lon);
        if(!near){
            updateStatus("âŒ ë°˜ê²½ 300mì— ìŠ¤íŠ¸ë¦¬íŠ¸ë·° ì—†ìŒ");
            return;
        }

        target_lat = near.lat;
        target_lon = near.lon;
        msg = `ğŸ“ ê·¼ì²˜ ìŠ¤íŠ¸ë¦¬íŠ¸ë·° (${near.radius}m ì´ë‚´), ë‚ ì§œ: ${pickedDate}`;
    }
    else{
        msg = `ğŸ“ í˜„ì¬ ìœ„ì¹˜ ìŠ¤íŠ¸ë¦¬íŠ¸ë·°, ë‚ ì§œ: ${pickedDate}`;
    }

    let heading = (yaw+360)%360;
    let pitch_v = Math.max(-90, Math.min(90, pitch));

    let url =
    `https://maps.googleapis.com/maps/api/streetview?size=2048x2048` +   // ê³ í™”ì§ˆ
    `&location=${target_lat},${target_lon}` +
    `&heading=${heading}` +
    `&pitch=${pitch_v}` +
    `&fov=90` +
    `&key=${API_KEY}`;

    img.src = url;

    img.onload = ()=>{
        ctx.clearRect(0,0,canvas.width,canvas.height);

        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2);
        ctx.rotate(roll*Math.PI/180);
        ctx.drawImage(img,-canvas.width/2,-canvas.height/2,canvas.width,canvas.height);
        ctx.restore();

        updateStatus(msg + " âœ”");
    };

    img.onerror = ()=>{
        updateStatus("âŒ ë¡œë”© ì‹¤íŒ¨(API ë˜ëŠ” ë„¤íŠ¸ì›Œí¬)");
    };
}

initGPS();
</script>

</body>
</html>
